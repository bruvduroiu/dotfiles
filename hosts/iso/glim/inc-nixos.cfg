# NixOS Live ISO for GLIM
# Custom Hyprland-based live environment
#
# Installation:
#   1. Build ISO: nix build .#nixosConfigurations.live-iso.config.system.build.isoImage
#   2. Mount the ISO: sudo mount -o loop result/iso/*.iso /tmp/iso-mount
#   3. Copy ISO to USB: sudo cp result/iso/*.iso /mnt/GLIM/boot/iso/nixos/
#   4. Extract kernel: sudo cp /tmp/iso-mount/boot/nix/store/*-linux-*/bzImage /mnt/GLIM/boot/iso/nixos/vmlinuz
#   5. Extract initrd: sudo cp /tmp/iso-mount/boot/nix/store/*-initrd-*/initrd /mnt/GLIM/boot/iso/nixos/initrd
#   6. Copy this file to /mnt/GLIM/boot/grub/inc-nixos.cfg
#   7. Unmount: sudo umount /tmp/iso-mount
#
# Note: Kernel and initrd must be extracted because NixOS stores them in hash-named
#       paths that change with each build. GRUB needs stable paths to boot.

function add_menu {
  isofile="$1"

  # Extract just the filename for display
  regexp --set=isoname '^.*/(.*)$' "${isofile}"

  menuentry "NixOS Live - ${isoname}" "${isofile}" --class nixos {
    set isofile=$2

    use "${isoname}"

    # Boot with findiso (locate ISO) + root=LABEL (mount from within ISO)
    linux $isopath/nixos/vmlinuz \
      init=/nix/store/b7gfyq0mzfgdwbrrg7cpdngrj6zbj4ib-nixos-system-nixos-live-25.11.20260102.64049ca/init \
      findiso=${isofile} \
      root=LABEL=NIXOS_LIVE \
      boot.shell_on_fail \
      nohibernate \
      lsm=landlock,yama,bpf
    initrd $isopath/nixos/initrd
  }

  menuentry "NixOS Live - ${isoname} (Copy to RAM)" "${isofile}" --class nixos {
    set isofile=$2

    use "${isoname}"

    linux $isopath/nixos/vmlinuz \
      init=/nix/store/b7gfyq0mzfgdwbrrg7cpdngrj6zbj4ib-nixos-system-nixos-live-25.11.20260102.64049ca/init \
      findiso=${isofile} \
      root=LABEL=NIXOS_LIVE \
      copytoram \
      boot.shell_on_fail \
      nohibernate \
      lsm=landlock,yama,bpf
    initrd $isopath/nixos/initrd
  }

  menuentry "NixOS Live - ${isoname} (Debug)" "${isofile}" --class nixos {
    set isofile=$2

    use "${isoname}"

    linux $isopath/nixos/vmlinuz \
      init=/nix/store/b7gfyq0mzfgdwbrrg7cpdngrj6zbj4ib-nixos-system-nixos-live-25.11.20260102.64049ca/init \
      findiso=${isofile} \
      root=LABEL=NIXOS_LIVE \
      boot.shell_on_fail \
      loglevel=7 \
      debug
    initrd $isopath/nixos/initrd
  }
}

for_each_sorted add_menu "$isopath"/nixos/nixos-*.iso

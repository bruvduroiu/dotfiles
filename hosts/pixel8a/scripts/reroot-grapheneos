#!/usr/bin/env bash
#
# Pixel 8a GrapheneOS Re-rooting Script
# Usage: ./reroot-grapheneos <release-version>
# Example: ./reroot-grapheneos 2026011000
#
# This script automates the process of re-rooting a Pixel 8a after a GrapheneOS update.
# Requirements:
# - nix-shell with android-tools, curl, unzip, payload-dumper-go
# - Magisk app installed on the device
# - Device connected via ADB with USB debugging enabled

set -euo pipefail

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Device codename
DEVICE="akita"

error() {
    echo -e "${RED}ERROR: $1${NC}" >&2
    exit 1
}

info() {
    echo -e "${BLUE}>>> $1${NC}"
}

success() {
    echo -e "${GREEN}âœ“ $1${NC}"
}

warn() {
    echo -e "${YELLOW}! $1${NC}"
}

check_nix_tools() {
    if ! command -v nix-shell &> /dev/null; then
        error "nix-shell not found. This script requires Nix package manager."
    fi
}

check_adb_device() {
    info "Checking ADB connection..."
    if ! nix-shell -p android-tools --run "adb devices" | grep -q "device$"; then
        error "No device connected. Please connect your Pixel 8a and authorize USB debugging."
    fi
    success "Device connected"
}

check_fastboot_device() {
    info "Checking fastboot connection..."
    if ! nix-shell -p android-tools --run "fastboot devices" | grep -q "fastboot"; then
        error "Device not in fastboot mode"
    fi
    success "Device in fastboot mode"
}

# Parse arguments
if [[ $# -ne 1 ]]; then
    echo "Usage: $0 <release-version>"
    echo ""
    echo "Example: $0 2026011000"
    echo ""
    echo "To find the latest release version:"
    echo "  Visit https://grapheneos.org/releases"
    echo "  Or check your current build: adb shell getprop ro.build.id"
    exit 1
fi

RELEASE="$1"
OTA_FILE="${DEVICE}-ota-${RELEASE}.zip"
OTA_URL="https://releases.grapheneos.org/${DEVICE}-ota_update-${RELEASE}.zip"

info "Pixel 8a GrapheneOS Re-rooting Script"
info "Release: $RELEASE"
echo ""

check_nix_tools

# Step 1: Download OTA image
if [[ -f "$OTA_FILE" ]]; then
    warn "OTA file already exists: $OTA_FILE"
    read -p "Download again? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -f "$OTA_FILE"
    fi
fi

if [[ ! -f "$OTA_FILE" ]]; then
    info "Downloading GrapheneOS OTA image (~1.2 GB)..."
    nix-shell -p curl --run "curl -L -o '$OTA_FILE' '$OTA_URL'" || error "Failed to download OTA image"
    success "Downloaded OTA image"
else
    success "Using existing OTA file"
fi

# Step 2: Extract init_boot.img
info "Extracting init_boot.img from payload..."
nix-shell -p unzip payload-dumper-go --run "
    unzip -p '$OTA_FILE' payload.bin > payload.bin && \
    payload-dumper-go -p init_boot -o . payload.bin
" || error "Failed to extract init_boot.img"
rm -f payload.bin
success "Extracted init_boot.img"

# Step 3: Push to device
check_adb_device
info "Pushing init_boot.img to device..."
nix-shell -p android-tools --run "adb push init_boot.img /sdcard/Download/init_boot.img" || error "Failed to push init_boot.img"
success "Pushed init_boot.img to /sdcard/Download/"

# Step 4: Wait for user to patch with Magisk
echo ""
warn "==== ACTION REQUIRED ===="
echo "On your Pixel 8a:"
echo "  1. Open the Magisk app"
echo "  2. Tap 'Install' (next to Magisk)"
echo "  3. Select 'Select and Patch a File'"
echo "  4. Navigate to Downloads and select 'init_boot.img'"
echo "  5. Tap 'Let's Go' and wait for patching to complete"
echo ""
read -p "Press ENTER when patching is complete..."

# Step 5: Find and pull patched image
info "Finding patched image on device..."
PATCHED_NAME=$(nix-shell -p android-tools --run "adb shell ls /sdcard/Download/magisk_patched*.img 2>/dev/null | tr -d '\r' | head -1")

if [[ -z "$PATCHED_NAME" ]]; then
    error "No patched image found. Did you patch the file with Magisk?"
fi

info "Found patched image: $(basename $PATCHED_NAME)"
nix-shell -p android-tools --run "adb pull '$PATCHED_NAME' ./magisk_patched_init_boot.img" || error "Failed to pull patched image"
success "Pulled patched init_boot.img"

# Step 6: Reboot to fastboot
info "Rebooting to fastboot mode..."
nix-shell -p android-tools --run "adb reboot bootloader"
sleep 10

# Step 7: Flash to both slots
check_fastboot_device
info "Flashing patched init_boot to both slots..."
nix-shell -p android-tools --run "
    fastboot flash init_boot_a ./magisk_patched_init_boot.img && \
    fastboot flash init_boot_b ./magisk_patched_init_boot.img
" || error "Failed to flash init_boot images"
success "Flashed to init_boot_a and init_boot_b"

# Step 8: Reboot
info "Rebooting to Android..."
nix-shell -p android-tools --run "fastboot reboot"
sleep 30

# Step 9: Verify root
info "Waiting for device to boot..."
nix-shell -p android-tools --run "adb wait-for-device"
sleep 5

info "Verifying root access..."
if nix-shell -p android-tools --run "adb shell 'su -c \"id\"'" | grep -q "uid=0(root)"; then
    success "Root access verified!"
    echo ""
    success "=== Re-rooting Complete ==="
    echo ""
    info "Your Pixel 8a is now rooted with Magisk"
    info "You can now run your router scripts:"
    echo "  adb shell"
    echo "  su"
    echo "  /data/local/tmp/router-start"
else
    error "Root verification failed. Please check Magisk app."
fi

# Cleanup
info "Cleaning up temporary files..."
rm -f payload.bin
success "Done!"
